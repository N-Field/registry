var v=Object.defineProperty;var j=Object.getOwnPropertyDescriptor;var B=Object.getOwnPropertyNames;var C=Object.prototype.hasOwnProperty;var y=(s,e)=>()=>(s&&(e=s(s=0)),e);var _=(s,e)=>()=>(e||s((e={exports:{}}).exports,e),e.exports);var l=(s,e,t,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let a of B(e))!C.call(s,a)&&a!==t&&v(s,a,{get:()=>e[a],enumerable:!(r=j(e,a))||r.enumerable});return s},i=(s,e,t)=>(l(s,e,"default"),t&&l(t,e,"default"));var h=s=>l(v({},"__esModule",{value:!0}),s);var o={};import*as z from"https://registry.koishi.chat/modules/koishi/index.js";var b=y(()=>{i(o,z)});var d={};import*as G from"https://registry.koishi.chat/modules/@koishijs/plugin-console/index.js";var x=y(()=>{i(d,G)});var I=_(()=>{});var V=_((T,M)=>{var c=Object.defineProperty,U=Object.getOwnPropertyDescriptor,E=Object.getOwnPropertyNames,K=Object.prototype.hasOwnProperty,u=(s,e)=>c(s,"name",{value:e,configurable:!0}),H=(s,e)=>{for(var t in e)c(s,t,{get:e[t],enumerable:!0})},$=(s,e,t,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let a of E(e))!K.call(s,a)&&a!==t&&c(s,a,{get:()=>e[a],enumerable:!(r=U(e,a))||r.enumerable});return s},A=s=>$(c({},"__esModule",{value:!0}),s),w={};H(w,{Config:()=>R,UserProvider:()=>p,apply:()=>k,name:()=>D,using:()=>L});M.exports=A(w);var S=(b(),h(o)),N=(x(),h(d)),Q=I(),n=(b(),h(o)),f=class extends n.Messenger{constructor(){super(...arguments),this.buffer=""}async flush(){if(!this.buffer.trim())return;let s=await n.segment.transformAsync(this.buffer.trim(),{image:async t=>(t.url.startsWith("file://"),t.url.startsWith("base64://")?n.segment.image("data:image/png;base64,"+t.url.slice(9)):(0,n.segment)("image",t))}),e=this.bot.session(this.session);e.messageId=n.Random.id(),e.app.console.broadcast("sandbox",{content:s,user:"Koishi",channel:e.channelId,id:e.messageId}),this.results.push(e),this.buffer=""}async visit(s){let{type:e,children:t}=s;e==="message"||e==="figure"?(await this.flush(),await this.render(t),await this.flush()):this.buffer+=s.toString()}};u(f,"SandboxMessenger");var O=class extends n.Bot{constructor(s){super(s,{platform:"sandbox",selfId:"koishi"}),this.ctx=s,this.username="koishi",this.hidden=!0,this.internal={};let e=this;s.console.addListener("sandbox/message",async function(t,r,a){let g=n.Random.id();s.console.broadcast("sandbox",{id:g,content:a,user:t,channel:r});let m=e.session({userId:t,content:a,messageId:g,channelId:r,guildId:r==="@"+t?void 0:r,type:"message",subtype:r==="@"+t?"private":"group",author:{userId:t,username:t}});(0,n.defineProperty)(m,"handle",this),e.dispatch(m)},{authority:4})}async sendMessage(s,e,t,r){return new f(this,s,t,r).send(e)}async sendPrivateMessage(s,e,t){return new f(this,"@"+s,void 0,t).send(e)}async deleteMessage(s,e){this.ctx.console.broadcast("sandbox/delete",{id:e,channel:s})}async getGuildMemberList(s){return P.map(e=>({nickname:e,userId:e}))}};u(O,"SandboxBot");var P=["Alice","Bob","Carol","Dave","Eve","Frank","Grace","Hank","Ivy","Jack","Kathy","Lily","Mandy","Nancy","Oscar","Peggy","Quinn","Randy","Sandy","Toby","Uma","Vicky","Wendy","Xander","Yvonne","Zoe"],q={commands:{clear:{description:"清空聊天记录"}}},p=class extends N.DataService{constructor(s){super(s,"users",{authority:4}),s.console.addListener("sandbox/user",async(e,t)=>{let r=await this.get();if(r[e]){if(!t)return delete r[e],this.ctx.$internal._userCache.set("sandbox","sandbox:"+e,null),this.ctx.database.remove("user",{sandbox:e})}else{if(!t)return;let a=await this.ctx.database.createUser("sandbox",e,{authority:1,...t});return this.observe(a,r)}return Object.assign(r[e],t),r[e].$update()},{authority:4})}observe(s,e){let t="sandbox:"+s.sandbox;e[s.sandbox]=(0,S.observe)(s,async r=>{await this.ctx.database.setUser("sandbox",s.sandbox,r),this.refresh()}),this.ctx.$internal._userCache.set("sandbox",t,e[s.sandbox])}async prepare(){let s=await this.ctx.database.getUser("sandbox",P),e={};for(let t of s)this.observe(t,e);return e}stop(){this.ctx.$internal._userCache.delete("sandbox")}async get(){return this.task||(this.task=this.prepare())}};u(p,"UserProvider");p.using=["database"];var D="sandbox",L=["console"],R=S.Schema.object({});function k(s,e){s.plugin(O),s.plugin(p),s.console.addEntry(["https://registry.koishi.chat/modules/@koishijs/plugin-sandbox/dist/index.js","https://registry.koishi.chat/modules/@koishijs/plugin-sandbox/dist/style.css"]),s.i18n.define("zh",q),s.platform("sandbox").command("clear").action(({session:t})=>{t.handle.send({type:"sandbox/clear"})})}u(k,"apply")});export default V();
