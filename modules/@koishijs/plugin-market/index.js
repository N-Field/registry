var I=Object.defineProperty;var R=Object.getOwnPropertyDescriptor;var E=Object.getOwnPropertyNames;var M=Object.prototype.hasOwnProperty;var _=(e,r,s,t)=>{if(r&&typeof r=="object"||typeof r=="function")for(let o of E(r))!M.call(e,o)&&o!==s&&I(e,o,{get:()=>r[o],enumerable:!(t=R(r,o))||t.enumerable});return e},d=(e,r,s)=>(_(e,r,"default"),s&&_(s,r,"default"));var a={};d(a,$);import*as $ from"https://registry.koishi.chat/modules/koishi/index.js";var c={};d(c,N);import*as N from"https://registry.koishi.chat/modules/@koishijs/plugin-console/index.js";var l={};d(l,q);import*as q from"https://registry.koishi.chat/modules/@koishijs/loader/index.js";var S=Object.defineProperty,B=(e,r,s)=>r in e?S(e,r,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[r]=s,f=(e,r)=>S(e,"name",{value:r,configurable:!0}),A=(e,r,s)=>(B(e,typeof r!="symbol"?r+"":r,s),s),L=new a.Logger("market"),v=class extends c.DataService{_task;_error;constructor(e){super(e,"market",{authority:4}),e.console.addListener("market/refresh",()=>this.start(),{authority:4})}start(){this._task=null}async prepare(){return this._task||=this.collect().catch(e=>{L.warn(e),this._error=e})}};f(v,"MarketProvider");var k=class extends c.DataService{constructor(e){super(e,"packages",{authority:4}),e.on("internal/runtime",r=>{this.update(r)}),e.on("internal/fork",r=>{this.update(r)})}update(e){this.refresh()}parseRuntime(e,r){r.id=e.uid,r.forkable=e.isForkable}};f(k,"PackageProvider");var y=class extends c.DataService{constructor(e){super(e,"services"),e.on("internal/service",()=>this.refresh())}async get(){let e={},r=Object.getOwnPropertyDescriptors(a.Context.prototype);for(let s in r){let t=r[s];if("value"in t)continue;let o=this.ctx[s]?.[a.Context.source]?.state.uid;o&&(e[s]=o)}return e}};f(y,"ServiceProvider");function C(e){return e.split(/\/?(@[\w-]+\/[\w:-]+|[\w:-]+)\/?/).filter(Boolean)}f(C,"splitPath");function P(e,r,s){for(let t of s)r[t]=e[t],delete e[t];Object.assign(e,r)}f(P,"insertKey");function h(e,r,s,t){let o=Object.keys(e),i=o.findIndex(u=>u===r||u==="~"+r),n=i<0?[]:o.slice(i+1),p={[s]:t};delete e[r],delete e["~"+r],P(e,p,n)}f(h,"rename");function O(e,r){r in e||(r="~"+r);let s=e[r];return delete e[r],{[r]:s}}f(O,"dropKey");var m=class extends c.DataService{loader;plugins;constructor(e){super(e,"config",{authority:4}),this.loader=e.loader,this.plugins=e.loader.config.plugins,e.console.addListener("manager/app-reload",r=>{this.reloadApp(r)},{authority:4});for(let r of["teleport","reload","unload","remove","group","meta","alias"])e.console.addListener(`manager/${r}`,this[r].bind(this),{authority:4});e.on("config",()=>this.refresh())}getGroup(e,r){let s={...e};for(let t in e){if(t.startsWith("$"))continue;let o=e[t];if(t.split(":",1)[0].replace(/^~/,"")==="group"){let n=r.state[l.Loader.kRecord][t];s[t]=this.getGroup(o,n.ctx)}}return s}async get(){let e={...this.loader.config};return e.plugins=this.getGroup(e.plugins,this.loader.entry),e}reloadApp(e){this.loader.config=e,this.loader.config.plugins=this.plugins,this.loader.writeConfig(),this.loader.fullReload()}resolve(e){let r=C(e);e.endsWith("/")&&r.push("");let s=this.loader.entry,t=r.shift();for(;r.length;)s=s.state[l.Loader.kRecord][t].ctx,t=r.shift();return[s.state,t]}alias(e,r){let[s,t]=this.resolve(e),o,i=t.split(":",1)[0]+(r?":":"")+r,n=s[l.Loader.kRecord],p=n[t];p?(delete n[t],n[i]=p,p.alias=r,p.ctx.emit("internal/fork",p),o=s.config[t]):(i="~"+i,o=s.config["~"+t]),h(s.config,t,i,o),this.loader.writeConfig()}meta(e,r){let[s,t]=this.resolve(e),o=e?s.config[t]:s.config;for(let i of Object.keys(r))r[i]===null?delete o[i]:o[i]=r[i];this.loader.writeConfig()}async reload(e,r,s){let[t,o]=this.resolve(e);s&&this.loader.unloadPlugin(t.ctx,o),await this.loader.reloadPlugin(t.ctx,s||o,r),h(t.config,o,s||o,r),this.loader.writeConfig(),this.refresh()}unload(e,r={},s){let[t,o]=this.resolve(e);this.loader.unloadPlugin(t.ctx,o),h(t.config,o,"~"+(s||o),r),this.loader.writeConfig(),this.refresh()}remove(e){let[r,s]=this.resolve(e);this.loader.unloadPlugin(r.ctx,s),delete r.config[s],delete r.config["~"+s],this.loader.writeConfig(),this.refresh()}async group(e){let[r,s]=this.resolve(e),t=r.config[s]={};await this.loader.reloadPlugin(r.ctx,s,t),this.loader.writeConfig(),this.refresh()}teleport(e,r,s){let[t,o]=this.resolve(e),[i]=this.resolve(r?r+"/":""),n=t[l.Loader.kRecord][o];n&&t!==i&&(delete t[l.Loader.kRecord][o],i[l.Loader.kRecord][o]=n,(0,a.remove)(t.disposables,n.dispose),i.disposables.push(n.dispose),n.parent=i.ctx,Object.setPrototypeOf(n.ctx,i.ctx),n.ctx.emit("internal/fork",n),n.runtime.using.some(x=>t[x]!==i[x])&&n.restart());let p=O(t.config,o),u=Object.keys(i.config).slice(s);P(i.config,p,u),this.loader.writeConfig()}};f(m,"ConfigWriter");A(m,"using",["console.packages"]);var j=Object.defineProperty,W=(e,r,s)=>r in e?j(e,r,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[r]=s,g=(e,r)=>j(e,"name",{value:r,configurable:!0}),D=(e,r,s)=>(W(e,typeof r!="symbol"?r+"":r,s),s),b=class extends c.DataService{constructor(e){super(e,"dependencies",{authority:4}),this.ctx=e}async get(e=!1){let s=(await this.ctx.console.market.prepare()).objects.filter(t=>t.portable);return Object.fromEntries(s.map(t=>[t.name,{request:t.version,resolved:t.version,versions:t.versions,latest:t.version}]))}};g(b,"Installer");D(b,"using",["console.market"]);var F=b,K=class extends v{start(){super.start(),this.refresh()}async collect(){return await(await fetch("https://registry.koishi.chat/market.json")).json()}async get(){let e=await this.prepare();return e?{data:Object.fromEntries(e.objects.map(r=>[r.name,r])),failed:0,total:e.objects.length,progress:e.objects.length}:{data:{},failed:0,total:0,progress:0}}};g(K,"MarketProvider");var w=class extends k{async getManifest(e){return(await this.ctx.console.market.prepare()).objects.find(s=>e===s.name.replace(/(koishi-|^@koishijs\/)plugin-/,""))?.manifest}async get(e=!1){let r=await this.ctx.console.market.prepare(),s=await Promise.all(r.objects.map(async t=>{let o=(0,a.pick)(t,["name","version","description","portable","manifest"]);if(o.shortname=t.name.replace(/(koishi-|^@koishijs\/)plugin-/,""),o.manifest=t.manifest,o.peerDependencies={...t.versions[t.version].peerDependencies},!o.portable)return;let i=await this.ctx.loader.resolvePlugin(t.shortname);o.schema=i?.Config||i?.schema,o.usage=i?.usage;let n=this.ctx.registry.get(i);return n&&this.parseRuntime(n,o),o}));return s.unshift({name:"",shortname:"",schema:a.Context.Config}),Object.fromEntries(s.filter(t=>t).map(t=>[t.name,t]))}};g(w,"PackageProvider");D(w,"using",["console.market"]);var pe="manager",fe=["console"],de=a.Schema.object({});function G(e,r){e.plugin(F),e.plugin(K),e.plugin(w),e.plugin(m),e.plugin(y),e.console.addEntry(["https://registry.koishi.chat/modules/@koishijs/plugin-market/dist/index.js","https://registry.koishi.chat/modules/@koishijs/plugin-market/dist/style.css"])}g(G,"apply");export{de as Config,m as ConfigWriter,F as Installer,K as MarketProvider,w as PackageProvider,y as ServiceProvider,G as apply,pe as name,C as splitPath,fe as using};
