var v=Object.defineProperty;var w=Object.getOwnPropertyDescriptor;var S=Object.getOwnPropertyNames;var j=Object.prototype.hasOwnProperty;var $=(t,e)=>()=>(t&&(e=t(t=0)),e);var y=(t,e)=>()=>(e||t((e={exports:{}}).exports,e),e.exports);var m=(t,e,c,u)=>{if(e&&typeof e=="object"||typeof e=="function")for(let n of S(e))!j.call(t,n)&&n!==c&&v(t,n,{get:()=>e[n],enumerable:!(u=w(e,n))||u.enumerable});return t},p=(t,e,c)=>(m(t,e,"default"),c&&m(c,e,"default"));var D=t=>m(v({},"__esModule",{value:!0}),t);var f={};import*as H from"https://registry.koishi.chat/modules/koishi/index.js";var I=$(()=>{p(f,H)});var k=y((z,q)=>{q.exports={commands:{market:{description:"插件市场信息",messages:{overview:"当前共有 {0} 个插件。"}}}}});var O=y(r=>{Object.defineProperty(r,"__esModule",{value:!0});r.apply=r.Config=r.Rule=r.name=void 0;var i=(I(),D(f)),C=new i.Logger("market");r.name="market-info";r.Rule=i.Schema.object({platform:i.Schema.string().description("平台名称。").required(),channelId:i.Schema.string().description("频道 ID。").required(),guildId:i.Schema.string().description("群组 ID。"),selfId:i.Schema.string().description("机器人 ID。")});r.Config=i.Schema.object({rules:i.Schema.array(r.Rule).description("推送规则。"),interval:i.Schema.number().default(i.Time.minute*30).description("轮询间隔 (毫秒)。"),showHidden:i.Schema.boolean().default(!1).description("是否显示隐藏的插件。"),showDeletion:i.Schema.boolean().default(!1).description("是否显示删除的插件。")});function M(t,e){t.i18n.define("zh",k());let c=n=>{let o={};for(let d of n.objects)d.manifest.hidden&&!e.showHidden||(o[d.shortname]=d);return o},u=async()=>{let n=await t.http.get("https://registry.koishi.chat/market.json");return c(n)};t.on("ready",async()=>{let n=await u();t.command("market").action(async({session:o})=>o.text(".overview",[Object.keys(n).length])),t.setInterval(async()=>{let o=await u(),d=Object.keys({...n,...o}).map(s=>{let l=n[s]?.version,a=o[s]?.version;if(l!==a){if(!l)return`新增：${s}`;if(a)return`更新：${s} (${l} → ${a})`;if(e.showDeletion)return`删除：${s}`}}).filter(Boolean).sort();if(n=o,!d.length)return;let g=["[插件市场更新]",...d].join(`
`);C.info(g);for(let{channelId:s,platform:l,selfId:a,guildId:b}of e.rules){if(!a){let h=await t.database.getChannel(l,s,["assignee","guildId"]);if(!h||!h.assignee)return;a=h.assignee,b=h.guildId}t.bots[`${l}:${a}`]?.sendMessage(s,g,b)}},e.interval)})}r.apply=M});export default O();
